// ======================================================
// CONFIG
// ======================================================

// Optional: alias codes she types → full address
// (e.g., in case you want to allow "HOME" instead of full street)
const LOCATION_ALIAS = {
  HOME: "123 Maple St, Springfield, IL",
  LS: "200 Lakeshore Rd, Springfield, IL",
  JACOBS: "14 Jacobs Ct, Springfield, IL",
  OFFICE: "500 Corporate Drive, Springfield, IL"
  // Add more...
};

// Mileage lookup table, generated by your batch script
// Format: "A|B": miles
const MILEAGE_TABLE = {
  "HOME|LS": 4.21,
  "LS|HOME": 4.21,
  "LS|JACOBS": 2.33,
  "JACOBS|LS": 2.33,
  "JACOBS|HOME": 5.82,
  "HOME|JACOBS": 5.82,
  // etc...
};

// Fallback if missing: geocode + directions API
const MAPBOX_TOKEN = "YOUR_MAPBOX_ACCESS_TOKEN_HERE";

// ------------------------------------------------------
// DOM elements
// ------------------------------------------------------

const inputBox = document.getElementById("locations");
const calculateBtn = document.getElementById("calculateBtn");
const statusDiv = document.getElementById("status");
const resultsDiv = document.getElementById("results");
const legsTableBody = document.querySelector("#legsTable tbody");
const totalMilesEl = document.getElementById("totalMiles");

// A new result block for daily totals
let dailyResultsDiv;

// ------------------------------------------------------
// Helpers
// ------------------------------------------------------

function setStatus(msg, isErr = false) {
  statusDiv.textContent = msg;
  statusDiv.classList.toggle("error", isErr);
}

function normalize(token) {
  return token.trim().toUpperCase().replace(/\s+/g, "");
}

function aliasToAddress(token) {
  const key = normalize(token);
  return LOCATION_ALIAS[key] || null;
}

function tableLookup(a, b) {
  const key = `${a}|${b}`;
  const rev = `${b}|${a}`;
  if (MILEAGE_TABLE[key] != null) return MILEAGE_TABLE[key];
  if (MILEAGE_TABLE[rev] != null) return MILEAGE_TABLE[rev];
  return null;
}

function metersToMiles(m) {
  return m / 1609.344;
}

function formatMiles(m) {
  return m.toFixed(2);
}

// Fallback cache for missing pairs
const fallbackCache = {}; // "A|B" → miles

// ======================================================
// Fallback API lookup (slow, only you will use this)
// ======================================================

async function geocode(address) {
  const url =
    `https://api.mapbox.com/geocoding/v5/mapbox.places/` +
    `${encodeURIComponent(address)}.json?access_token=${MAPBOX_TOKEN}&limit=1`;

  const rsp = await fetch(url);
  if (!rsp.ok) throw new Error("Geocode failed");
  const data = await rsp.json();
  if (!data.features?.length) throw new Error("No geocode match");
  const [lon, lat] = data.features[0].center;
  return { lat, lon };
}

async function routeMeters(from, to) {
  const coords = `${from.lon},${from.lat};${to.lon},${to.lat}`;
  const url =
    `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}` +
    `?access_token=${MAPBOX_TOKEN}&overview=false`;

  const rsp = await fetch(url);
  if (!rsp.ok) throw new Error("Directions failed");
  const data = await rsp.json();
  if (!data.routes?.length) throw new Error("No route returned");
  return data.routes[0].distance; // meters
}

async function fallbackLookup(a, b) {
  const key = `${a}|${b}`;
  if (fallbackCache[key] != null) return fallbackCache[key];

  // Ask YOU (not her) for addresses if needed
  let addrA = al
